name: Postman API Tests (Core)

on:
  push:
    branches:
      [ main ]

  workflow_dispatch:

  schedule:
      - cron: "0 0 */14 * 0"  # 14 days once in UTC

jobs:
  automated-api-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh

      - name: Login to Postman CLI (using API Key)
        run: postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}

      - name: Run Core API Tests (HTML + JUnit Reports)
        run: |
          postman collection run "46701380-0865a434-1493-44c0-a8d2-54697cf8b8d9" -e "46701380-9eb25a31-affe-4a89-83d5-646bd2f110d5" \
            --reporters junit,html \
            --reporter-junit-export postman_report.xml \
            --reporter-html-export postman_report.html
      - name: Run Data-Driven API Tests
        run: |
          postman collection run "46701380-f03802e1-b0d3-4325-950f-b31b638bb326" \
            -e "46701380-9eb25a31-affe-4a89-83d5-646bd2f110d5" \
            -d postman/data/TestDataforproductcreation01.csv \
            --reporters junit,html \
            --reporter-junit-export postman_report2.xml \
            --reporter-html-export postman_report2.html

      - name: Debug - List directory
        run: ls -lah

      - name: Upload HTML Report for Postman API Tests (Core)
        uses: actions/upload-artifact@v4
        with:
          name: Postman-HTML-Report
          path: postman_report.html
          retention-days: 30

      - name: Upload JUnit Report for Postman API Tests (Core)
        uses: actions/upload-artifact@v4
        with:
          name: Postman-JUnit-Report
          path: postman_report.xml
          retention-days: 30

      - name: Upload HTML Report for Data-Driven API Tests
        uses: actions/upload-artifact@v4
        with:
          name: Postman-HTML-Report_Datadriven
          path: postman_report2.html
          retention-days: 30

      - name: Upload JUnit Report for Data-Driven API Tests
        uses: actions/upload-artifact@v4
        with:
          name: Postman-JUnit-Report_Datadriven
          path: postman_report2.xml
          retention-days: 30

      - name: Finish Job
        run: echo "API Tests finished with HTML + JUnit reports."
